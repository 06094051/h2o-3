#'
#' Cox Proportional Hazards Model
#'
#' Builds a Cox proportional hazards model on an H2OFrame
#'
#' @param x A vector containing the \code{character} names of the predictors in the model.
#' @param y The name of the response variable in the model.
#' @param training_frame An H2OFrame object containing the variables in the model.
#' @param model_id (Optional) The unique id assigned to the resulting model. If
#'        none is given, an id will automatically be generated.
#' @param validation_frame An H2OFrame object containing the variables in the model.  Defaults to NULL.
#' @export
h2o.coxph <- function(x, y, training_frame, model_id,
                      ## AUTOGENERATED PARAMETERS ##     # these defaults are not read by h2o
                      validation_frame = NULL,           # h2o generates its own default parameters
                      ignore_const_cols = TRUE,
                      offset_column = NULL,                    
                      weights_column = NULL,
                      ties = c("efron", "breslow"), 
                      init = 0,
                      control = h2o.coxph.control(...),
                      ...)
{
  # Required args: training_frame
  if( missing(training_frame) ) stop("argument \"training_frame\" is missing, with no default")
  
  # Training_frame may be a key or an H2O H2OFrame object
  if (!is.H2OFrame(training_frame))
    tryCatch(training_frame <- h2o.getFrame(training_frame),
             error = function(err) {
               stop("argument \"training_frame\" must be a valid H2OFrame or key")
             })
  # Parameter list to send to model builder
  parms <- list()
  parms$training_frame <- training_frame
  args <- .verify_dataxy(training_frame, x, y)
  if( !missing(offset_column) && !is.null(offset_column))  args$x_ignore <- args$x_ignore[!( offset_column == args$x_ignore )]
  if( !missing(weights_column) && !is.null(weights_column)) args$x_ignore <- args$x_ignore[!( weights_column == args$x_ignore )]
  if( !missing(validation_frame) )          parms$validation_frame       <- validation_frame
  if( !missing(model_id) )                  parms$model_id               <- model_id
  if( !missing(ignore_const_cols)  )        parms$ignore_const_cols      <- ignore_const_cols
  if( !missing(ties) )                      parms$ties                   <- match.arg(ties)
  if( !missing(init))                       parms$init                   <- init
  if( !missing(control))                    parms$lre_min                <- control$lre
  if( !missing(control))                    parms$lre_max                <- control$iter.max
  
  ny <- length(y)
  parms$start_column <- if(ny == 3L) y[1L] else NULL
  parms$stop_column  <-  y[ny - 1L]
  parms$event_column <- y[ny]
  parms$x_columns <- args$x
  
  # Error check and build model
  .h2o.modelJob('coxph', parms)
}

h2o.coxph.control <- function(lre = 9, iter.max = 20, ...)
{
  if (!is.numeric(lre) || length(lre) != 1L || is.na(lre) || lre <= 0)
    stop("'lre' must be a positive number")
  
  if (!is.numeric(iter.max) || length(iter.max) != 1L || is.na(iter.max) ||
      iter.max < 1)
    stop("'iter.max' must be a positive integer")
  
  list(lre = lre, iter.max = as.integer(iter.max))
}